<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/image/cinewatch.png" type="image/png">
    <title>Panneau Admin - Forum</title>
</head>
<body data-user-role="{{.CurrentUserRole}}">
    <div class="dashboard-container">
        <!-- Logo en haut à gauche -->
        <div class="site-logo">
            <a href="/entry/home">
                <img src="/static/image/cinewatch.png" alt="Logo du site" width="120">
            </a>
        </div>
        
        <h2>Panneau d'administration</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Rôle</th>
                    <th>Action</th>
                    <th>Bannissement</th>
                    <th>Warn</th>
                </tr>
            </thead>
            <tbody>
                {{range .Users}}
                <tr>
                    <td>{{.Username}}</td>
                    <td>
                        <select id="role-{{.ID}}" data-userid="{{.ID}}" class="role-dropdown">
                            <option value="user" {{if eq .Role "user"}}selected{{end}}>User</option>
                            <option value="moderator" {{if eq .Role "moderator"}}selected{{end}}>Moderator</option>
                            <option value="admin" {{if eq .Role "admin"}}selected{{end}}>Admin</option>
                        </select>
                    </td>
                    <td>
                        <button data-userid="{{.ID}}" class="update-role-btn">Mettre à jour</button>
                    </td>
                    <td>
                        <button data-userid="{{.ID}}" data-banned="{{.Banned}}" class="ban-toggle-btn">
                            {{if .Banned}}Débannir{{else}}Bannir{{end}}
                        </button>
                    </td>
                    <td>
                        <button class="warn-user-btn" data-userid="{{.ID}}" data-username="{{.Username}}">
                            Casier
                        </button>
                        <span class="warn-count" id="warn-count-{{.ID}}">
                            ({{index $.WarnCounts .ID}})
                        </span>
                    </td>                                
                </tr>
                {{end}}
            </tbody>
        </table>

        <h3>Posts signalés</h3>
        <ul>
            {{range .Reports}}
            <li class="report-item">
                <div><strong>Post signalé :</strong></div>
                <div class="report-content">"{{.PostContent}}"</div>
                
                {{if .PostImage}}
                <div>
                    <strong>Image :</strong>
                    <img src="/entry/image/{{.PostID}}" alt="Image du post" width="200" style="cursor: pointer;" onclick="openModal('/entry/image/{{.PostID}}')">
                </div>
                {{end}}
                
                <div><strong>Auteur du post :</strong> {{.PostAuthor}}</div>
                <div><strong>Signalé par :</strong> {{.Reporter}}</div>
                <div><strong>Raison :</strong> {{.Reason}}</div>
                <div><strong>Date :</strong> {{.CreatedAt.Format "02/01/2006 15:04"}}</div>
                
                <div class="report-actions">
                    <button class="delete-report-btn" data-reportid="{{.ID}}">
                        Supprimer le signalement
                    </button>

                    <button class="ban-post-author-btn" data-userid="{{.PostAuthorID}}">
                        Bannir l'auteur du post
                    </button>

                    <button class="delete-post-btn" data-postid="{{.PostID}}">
                        Supprimer le post (et le signalement)
                    </button>    
                </div>        
            </li>
            {{end}}
        </ul>

        <h3>Commentaires signalés</h3>
        <ul>
            {{range .CommentReports}}
            <li class="report-item">
                <div><strong>Commentaire signalé :</strong></div>
                <div class="report-content">"{{.CommentText}}"</div>
                
                <div><strong>Auteur :</strong> {{.CommentAuthor}}</div>
                <div><strong>Signalé par :</strong> {{.Reporter}}</div>
                <div><strong>Raison :</strong> {{.Reason}}</div>
                <div><strong>Date :</strong> {{.CreatedAt.Format "02/01/2006 15:04"}}</div>
                
                <div class="report-actions">
                    <button class="delete-comment-report-btn" data-reportid="{{.ID}}">
                        Supprimer le signalement
                    </button>

                    <button class="ban-comment-author-btn" data-userid="{{.CommentAuthorID}}">
                        Bannir l'auteur du commentaire
                    </button>

                    <button class="delete-comment-btn" data-commentid="{{.CommentID}}">
                        Supprimer le commentaire (et le signalement)
                    </button>
                </div>                
            </li>
            {{end}}
        </ul>

        <!-- Fenêtre modale pour afficher les images en grand -->
        <div id="imageModal" onclick="closeModal()">
            <span class="close">&times;</span>
            <img id="modalContent">
        </div>

        <div id="warnModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); z-index:999;">
            <h3 id="warnModalTitle">Casier</h3>
            <ul id="warnList"></ul>
            <textarea id="warnReason" placeholder="Raison de l'avertissement..." rows="3"></textarea>
            <div style="display: flex; gap: 10px; justify-content: space-between;">
                <button id="addWarnBtn" style="flex: 1; background-color: #ff9800;">Ajouter un avertissement</button>
                <button onclick="closeWarnModal()" style="flex: 1; background-color: #333;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Conteneur des notifications -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Conteneur pour la boîte de confirmation -->
    <div class="confirm-overlay" id="confirm-overlay" style="display: none;">
        <div class="confirm-dialog" id="confirm-dialog">
            <div class="confirm-title" id="confirm-title">Confirmation</div>
            <div class="confirm-message" id="confirm-message"></div>
            <div class="confirm-buttons">
                <button class="confirm-cancel" id="confirm-cancel">Annuler</button>
                <button class="confirm-ok" id="confirm-ok">Confirmer</button>
            </div>
        </div>
    </div>

<script>
// Fonction de gestion des notifications
function showNotification(message, type = 'success', duration = 5000) {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    const id = 'notification-' + Date.now();
    notification.id = id;
    notification.className = `notification ${type}`;

    notification.innerHTML = `
        <div class="notification-content">${message}</div>
        <button class="notification-close" onclick="removeNotification('${id}')">&times;</button>
        <div class="notification-progress" style="animation: progressBar ${duration}ms linear forwards;"></div>
    `;

    container.appendChild(notification);

    // Supprimer automatiquement après la durée spécifiée
    setTimeout(() => {
        removeNotification(id);
    }, duration);
}

function removeNotification(id) {
    const notification = document.getElementById(id);
    if (!notification) return;
    
    notification.style.animation = 'slideOut 0.3s ease-out forwards';
    setTimeout(() => {
        notification.remove();
    }, 300);
}

// Fonction de confirmation personnalisée
function showConfirm(message, options = {}) {
    return new Promise((resolve) => {
        const overlay = document.getElementById('confirm-overlay');
        const dialog = document.getElementById('confirm-dialog');
        const title = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const okButton = document.getElementById('confirm-ok');
        const cancelButton = document.getElementById('confirm-cancel');
        
        // Définir le type (danger, success, warning)
        dialog.className = 'confirm-dialog';
        okButton.className = 'confirm-ok';
        
        if (options.type) {
            dialog.classList.add(options.type);
            okButton.classList.add(options.type);
        } else {
            dialog.classList.add('danger'); // Par défaut
            okButton.classList.add('danger'); 
        }
        
        // Définir titre et message
        title.textContent = options.title || 'Confirmation';
        messageEl.textContent = message;
        
        // Définir texte des boutons
        okButton.textContent = options.okText || 'Confirmer';
        cancelButton.textContent = options.cancelText || 'Annuler';
        
        // Afficher la boîte de dialogue
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.classList.add('confirm-visible');
        }, 10);
        
        // Gestionnaires d'événements
        function handleOk() {
            overlay.classList.remove('confirm-visible');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            okButton.removeEventListener('click', handleOk);
            cancelButton.removeEventListener('click', handleCancel);
            resolve(true);
        }
        
        function handleCancel() {
            overlay.classList.remove('confirm-visible');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            okButton.removeEventListener('click', handleOk);
            cancelButton.removeEventListener('click', handleCancel);
            resolve(false);
        }
        
        okButton.addEventListener('click', handleOk);
        cancelButton.addEventListener('click', handleCancel);
    });
}

// Remplacer les alertes par notre système de notifications
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".update-role-btn").forEach(button => {
        button.addEventListener("click", function () {
            let userID = this.getAttribute("data-userid");
            let newRole = document.getElementById(`role-${userID}`).value;

            fetch('/admin/secure/change-role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userID, role: newRole })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification("Rôle mis à jour avec succès !", "success");
                } else {
                    showNotification("Erreur : " + data.message, "error");
                }
            })
            .catch(error => {
                console.error("Erreur :", error);
                showNotification("Une erreur est survenue.", "error");
            });
        });
    });
});


// Bannir / Débannir
document.querySelectorAll(".ban-toggle-btn").forEach(button => {
    button.addEventListener("click", function () {
        let userID = this.getAttribute("data-userid");
        let isBanned = this.getAttribute("data-banned") === "true";
        let newBannedState = !isBanned;

        fetch('/admin/secure/toggle-ban', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userID, banned: newBannedState })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.innerText = newBannedState ? "Débannir" : "Bannir";
                this.setAttribute("data-banned", newBannedState.toString());
                showNotification("Utilisateur " + (newBannedState ? "banni" : "débanni") + " avec succès !", "success");
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        })
        .catch(error => {
            console.error("Erreur :", error);
            showNotification("Une erreur est survenue.", "error");
        });
    });
});

// Fonctions modales d'image inchangées
function openModal(imageSrc) {
    let modal = document.getElementById("imageModal");
    let modalImg = document.getElementById("modalContent");

    modalImg.src = imageSrc;
    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.opacity = "1";
        modalImg.style.transform = "scale(1)";
    }, 10);
}

function closeModal() {
    let modal = document.getElementById("imageModal");
    let modalImg = document.getElementById("modalContent");

    modal.style.opacity = "0";
    modalImg.style.transform = "scale(0.5)";
    setTimeout(() => {
        modal.style.display = "none";
    }, 300);
}

// Supprimer un signalement
document.querySelectorAll(".delete-report-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const reportIDString = button.getAttribute("data-reportid");
        const reportID = parseInt(reportIDString, 10);

        const confirmed = await showConfirm("Voulez-vous vraiment supprimer ce signalement ?", {
            title: "Supprimer le signalement",
            type: "danger",
            okText: "Supprimer"
        });
        
        if (!confirmed) return;

        fetch("/admin/delete-report-post", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ report_id: reportID }) 
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Signalement supprimé !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        });
    });
});

// Bannir l'auteur du post signalé
document.querySelectorAll(".ban-post-author-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const userID = button.getAttribute("data-userid");
        
        const confirmed = await showConfirm("Voulez-vous vraiment bannir cet utilisateur ?", {
            title: "Bannir l'utilisateur",
            type: "danger",
            okText: "Bannir"
        });
        
        if (!confirmed) return;

        fetch("/admin/secure/toggle-ban", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userID, banned: true })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Utilisateur banni !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        });
    });
});

// Supprimer un post signalé
document.querySelectorAll(".delete-post-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const postID = parseInt(button.getAttribute("data-postid"), 10);
        
        const confirmed = await showConfirm("Voulez-vous vraiment supprimer ce post, ses commentaires et signalements ?", {
            title: "Supprimer le post",
            type: "danger",
            okText: "Supprimer"
        });
        
        if (!confirmed) return;

        fetch("/admin/delete-post", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ post_id: postID.toString() })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Post supprimé !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        })
        .catch(() => showNotification("Erreur lors de la suppression du post.", "error"));
    });
});


let currentWarnUserID = null;

function closeWarnModal() {
    document.getElementById("warnModal").style.display = "none";
    document.getElementById("warnList").innerHTML = "";
    document.getElementById("warnReason").value = "";
}

// Ouvre le casier
const userRole = document.body.dataset.userRole;
const isAdmin = userRole === "admin";

document.querySelectorAll(".warn-user-btn").forEach(button => {
    button.addEventListener("click", () => {
        const userID = button.getAttribute("data-userid");
        const username = button.getAttribute("data-username");
        currentWarnUserID = userID;

        document.getElementById("warnModalTitle").innerText = `Casier de ${username}`;

        fetch(`/admin/warns?user_id=${userID}`)
            .then(res => res.json())
            .then(data => {
                const warnList = document.getElementById("warnList");
                warnList.innerHTML = "";
                data.forEach(warn => {
                    const li = document.createElement("li");
                    const date = new Date(warn.CreatedAt).toLocaleString("fr-FR", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit"
                    });

                    li.innerHTML = `
                        <div><strong>Modérateur :</strong> <span>${warn.Issuer}</span></div>
                        <div><strong>Raison :</strong> <span>${warn.Reason}</span></div>
                        <div><strong>Date :</strong> <span>${date}</span></div>
                    `;

                    if (isAdmin) {
                        const deleteBtn = document.createElement("button");
                        deleteBtn.innerText = "Supprimer";
                        deleteBtn.addEventListener("click", async () => {
                            const confirmed = await showConfirm("Voulez-vous vraiment supprimer cet avertissement ?", {
                                title: "Supprimer l'avertissement",
                                type: "danger",
                                okText: "Supprimer"
                            });
                            
                            if (!confirmed) return;

                            fetch(`/admin/secure/delete-warn`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ warn_id: warn.ID })
                            })
                            .then(res => res.json())
                            .then(resp => {
                                if (resp.success) {
                                    showNotification("Warn supprimé !", "success");
                                    // Supprimer le warn du DOM
                                    li.remove();

                                    // Actualiser le compteur sans recharger tout
                                    const counterSpan = document.getElementById(`warn-count-${currentWarnUserID}`);
                                    let currentCount = parseInt(counterSpan.textContent.replace(/[^\d]/g, ""));
                                    if (!isNaN(currentCount) && currentCount > 0) {
                                        counterSpan.textContent = `(${currentCount - 1})`;
                                    }
                                } else {
                                    showNotification("Erreur : " + resp.message, "error");
                                }
                            });
                        });
                        li.appendChild(deleteBtn);
                    }

                    warnList.appendChild(li);
                });

                document.getElementById("warnModal").style.display = "block";
            });
    });
});


document.getElementById("addWarnBtn").addEventListener("click", () => {
    const reason = document.getElementById("warnReason").value.trim();
    if (!reason) {
        showNotification("Raison obligatoire !", "warning");
        return;
    }

    fetch("/admin/add-warn", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentWarnUserID, reason: reason })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification("Avertissement ajouté !", "success");
            document.getElementById(`warn-count-${currentWarnUserID}`).textContent = `(${data.new_count})`;
            closeWarnModal();
        } else {
            showNotification("Erreur : " + data.message, "error");
        }
    });
});


// Supprimer un signalement de commentaire
document.querySelectorAll(".delete-comment-report-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const reportID = parseInt(button.getAttribute("data-reportid"), 10);
        
        const confirmed = await showConfirm("Voulez-vous vraiment supprimer ce signalement de commentaire ?", {
            title: "Supprimer le signalement",
            type: "danger",
            okText: "Supprimer"
        });
        
        if (!confirmed) return;

        fetch("/admin/delete-report-comment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ report_id: reportID })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Signalement supprimé !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        });
    });
});


// Bannir l'auteur du commentaire signalé
document.querySelectorAll(".ban-comment-author-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const userID = button.getAttribute("data-userid");
        
        const confirmed = await showConfirm("Voulez-vous vraiment bannir cet utilisateur ?", {
            title: "Bannir l'utilisateur",
            type: "danger",
            okText: "Bannir"
        });
        
        if (!confirmed) return;

        fetch("/admin/secure/toggle-ban", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userID, banned: true })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Utilisateur banni !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        });
    });
});

// Supprimer un commentaire signalé
document.querySelectorAll(".delete-comment-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const commentID = parseInt(button.getAttribute("data-commentid"), 10);
        
        const confirmed = await showConfirm("Voulez-vous vraiment supprimer ce commentaire ?", {
            title: "Supprimer le commentaire",
            type: "danger",
            okText: "Supprimer"
        });
        
        if (!confirmed) return;

        fetch("/admin/delete-comment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment_id: commentID })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showNotification("Commentaire supprimé !", "success");
                location.reload();
            } else {
                showNotification("Erreur : " + data.message, "error");
            }
        })
        .catch(() => showNotification("Erreur lors de la suppression du commentaire.", "error"));
    });
});
</script>
</body>
</html>