<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <title>Panneau Admin</title>
</head>
<body>
    <h2>Panneau d'administration</h2>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Nom d'utilisateur</th>
            <th>Rôle</th>
            <th>Action</th>
            <th>Bannissement</th>
            <th>Warn</th>
        </tr>
        {{range .Users}}
        <tr>
            <td>{{.ID}}</td>
            <td>{{.Username}}</td>
            <td>
                <select id="role-{{.ID}}" data-userid="{{.ID}}" class="role-dropdown">
                    <option value="user" {{if eq .Role "user"}}selected{{end}}>User</option>
                    <option value="moderator" {{if eq .Role "moderator"}}selected{{end}}>Moderator</option>
                    <option value="admin" {{if eq .Role "admin"}}selected{{end}}>Admin</option>
                </select>
            </td>
            <td>
                <button data-userid="{{.ID}}" class="update-role-btn">Mettre à jour</button>
            </td>
            <td>
                <button data-userid="{{.ID}}" data-banned="{{.Banned}}" class="ban-toggle-btn">
                    {{if .Banned}}Débannir{{else}}Bannir{{end}}
                </button>
            </td>
            <td>
                <button class="warn-user-btn" data-userid="{{.ID}}" data-username="{{.Username}}">
                    Casier
                </button>
                <span class="warn-count" id="warn-count-{{.ID}}">
                    ({{index $.WarnCounts .ID}})
                </span>
            </td>                                
        </tr>
        {{end}}
    </table>

    <h3>Signalements récents</h3>
    <ul>
        {{range .Reports}}
        <li style="margin-bottom: 25px; border-bottom: 1px solid #444; padding-bottom: 15px;">
            <strong>Post signalé</strong><br>
            <strong>Contenu :</strong> "{{.PostContent}}"<br>
            {{if .PostImage}}
                <strong>Image :</strong><br>
                <img src="/entry/image/{{.PostID}}" alt="Image du post"  width="200" style="cursor: pointer;" onclick="openModal('/entry/image/{{.PostID}}')"><br>
            {{end}}
            <strong>Auteur du post :</strong> {{.PostAuthor}}<br>
            <strong>Signalé par :</strong> {{.Reporter}}<br>
            <strong>Raison :</strong> {{.Reason}}<br>
            <strong>Date :</strong> {{.CreatedAt.Format "02/01/2006 15:04"}}
            <br><br>
            <button class="delete-report-btn" data-reportid="{{.ID}}">
                Supprimer le signalement
            </button>

            <button class="ban-post-author-btn" data-userid="{{.PostAuthorID}}">
                Bannir l'auteur du post
            </button>
            
        </li>
        {{end}}
    </ul>

    <!-- Fenêtre modale pour afficher les images en grand -->
    <div id="imageModal" onclick="closeModal()">
        <span class="close">&times;</span>
        <img id="modalContent">
    </div>

    <div id="warnModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:2px solid #333; max-width:500px; z-index:999;">
        <h3 id="warnModalTitle">Casier</h3>
        <ul id="warnList" style="max-height:200px; overflow:auto;"></ul>
        <textarea id="warnReason" placeholder="Raison du warn..." rows="3" style="width:100%;"></textarea><br>
        <button id="addWarnBtn">Ajouter un avertissement</button>
        <button onclick="closeWarnModal()">Fermer</button>
    </div>    
    

</body>
</html>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".update-role-btn").forEach(button => {
            button.addEventListener("click", function () {
                let userID = this.getAttribute("data-userid");
                let newRole = document.getElementById(`role-${userID}`).value;

                fetch('/admin/secure/change-role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userID, role: newRole })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Rôle mis à jour avec succès !");
                    } else {
                        alert("Erreur : " + data.message);
                    }
                })
                .catch(error => {
                    console.error("Erreur :", error);
                    alert("Une erreur est survenue.");
                });
            });
        });
    });


    // Bannir / Débannir
    document.querySelectorAll(".ban-toggle-btn").forEach(button => {
        button.addEventListener("click", function () {
            let userID = this.getAttribute("data-userid");
            let isBanned = this.getAttribute("data-banned") === "true";
            let newBannedState = !isBanned;

            fetch('/admin/secure/toggle-ban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userID, banned: newBannedState })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.innerText = newBannedState ? "Débannir" : "Bannir";
                    this.setAttribute("data-banned", newBannedState.toString());
                    alert("Utilisateur " + (newBannedState ? "banni" : "débanni") + " avec succès !");
                } else {
                    alert("Erreur : " + data.message);
                }
            })
            .catch(error => {
                console.error("Erreur :", error);
                alert("Une erreur est survenue.");
            });
        });
    });

    function openModal(imageSrc) {
    let modal = document.getElementById("imageModal");
    let modalImg = document.getElementById("modalContent");

    modalImg.src = imageSrc;
    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.opacity = "1";
        modalImg.style.transform = "scale(1)";
    }, 10);
}

    function closeModal() {
        let modal = document.getElementById("imageModal");
        let modalImg = document.getElementById("modalContent");

        modal.style.opacity = "0";
        modalImg.style.transform = "scale(0.5)";
        setTimeout(() => {
            modal.style.display = "none";
        }, 300);
    }

    // Supprimer un signalement
    document.querySelectorAll(".delete-report-btn").forEach(button => {
        button.addEventListener("click", () => {
            const reportIDString = button.getAttribute("data-reportid");
            const reportID = parseInt(reportIDString, 10);

            if (!confirm("Supprimer ce signalement ?")) return;

            fetch("/admin/delete-report", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ report_id: reportID }) 
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Signalement supprimé !");
                    location.reload();
                } else {
                    alert("Erreur : " + data.message);
                }
            });
        });
    });

    // Bannir l'auteur du post signalé
    document.querySelectorAll(".ban-post-author-btn").forEach(button => {
        button.addEventListener("click", () => {
            const userID = button.getAttribute("data-userid");
            if (!confirm("Bannir cet utilisateur ?")) return;

            fetch("/admin/secure/toggle-ban", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userID, banned: true })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Utilisateur banni !");
                    location.reload();
                } else {
                    alert("Erreur : " + data.message);
                }
            });
        });
    });


    let currentWarnUserID = null;

    function closeWarnModal() {
        document.getElementById("warnModal").style.display = "none";
        document.getElementById("warnList").innerHTML = "";
        document.getElementById("warnReason").value = "";
    }

    document.querySelectorAll(".warn-user-btn").forEach(button => {
        button.addEventListener("click", () => {
            const userID = button.getAttribute("data-userid");
            const username = button.getAttribute("data-username");
            currentWarnUserID = userID;

            document.getElementById("warnModalTitle").innerText = `Casier de ${username}`;

            fetch(`/admin/warns?user_id=${userID}`)
                .then(res => res.json())
                .then(data => {
        console.log("Warns reçus :", data);

        const warnList = document.getElementById("warnList");
        warnList.innerHTML = "";
        data.forEach(warn => {
        const li = document.createElement("li");
        const date = new Date(warn.CreatedAt).toLocaleString("fr-FR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });

        li.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Modérateur :</strong> ${warn.Issuer}<br>
                <strong>Raison :</strong> ${warn.Reason}<br>
                <strong>Date :</strong> ${date}
            </div>
        `;
        warnList.appendChild(li);
    });
        document.getElementById("warnModal").style.display = "block";
    })

        });
    });

    document.getElementById("addWarnBtn").addEventListener("click", () => {
        const reason = document.getElementById("warnReason").value.trim();
        if (!reason) {
            alert("Raison obligatoire !");
            return;
        }

        fetch("/admin/add-warn", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: currentWarnUserID, reason: reason })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Avertissement ajouté !");
                document.getElementById(`warn-count-${currentWarnUserID}`).textContent = `(${data.new_count})`;
                closeWarnModal();
            } else {
                alert("Erreur : " + data.message);
            }
        });
    });


</script>