<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/profile.css">
    <title>Profil</title>
</head>
<body>
    <h2>Profil de {{.User.Username}}</h2>
    <p><strong>Nom d'utilisateur :</strong> <span id="display-username">{{.User.Username}}</span></p>
    {{if .IsOwner}}
    <p><strong>Email :</strong> <span id="display-email">{{.User.Email}}</span></p>
    {{end}}
    <p><strong>Rôle :</strong> {{.User.Role}}</p>

    {{if .IsOwner}}
    <h3>Modifier mon profil</h3>
    <form id="profile-form">
        <label>Nom d'utilisateur :</label>
        <input type="text" id="username" value="{{.User.Username}}" required><br>
    
        <label>Email :</label>
        <input type="email" id="email" value="{{.User.Email}}" required><br>
    
        <label>Ancien mot de passe :</label>
        <input type="password" id="old-password"><br>
    
        <label>Nouveau mot de passe :</label>
        <input type="password" id="new-password"><br>

        <label>
            <input type="checkbox" id="is-public" {{if .User.IsPublic}}checked{{end}}>
            Rendre mon compte public
        </label><br>    
    
        <button type="submit">Enregistrer</button>
    </form>
    
    <p id="success-message" style="color:green; display:none;">Mise à jour réussie !</p>
    <p id="error-message" style="color:red; display:none;"></p>
    
    <a href="/auth/logout">Se déconnecter</a>
    
    <h3>Warn</h3>
    <button id="openWarnBtn">
        Casier (<span id="warnCount">{{len .User.Warns}}</span>)
    </button>
    
    <!-- Modale du casier -->
    <div id="warnModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:2px solid #333; max-width:500px; z-index:999;">
        <h3>Mes avertissements</h3>
        <ul id="warnList" style="max-height:200px; overflow:auto;">
            {{range .User.Warns}}
            <li style="margin-bottom: 10px; border-bottom: 1px solid #555; padding: 5px;">
                <strong>Modérateur :</strong> {{.Issuer}}<br>
                <strong>Raison :</strong> {{.Reason}}<br>
                <strong>Date :</strong> {{.CreatedAt.Format "02/01/2006 15:04"}}
            </li>
            {{end}}
        </ul>
        <button onclick="closeWarnModal()">Fermer</button>
    </div>
    {{end}}

    {{if or .User.IsPublic .IsOwner}}
        <h3>Activité de l'utilisateur</h3>
        <ul>
        {{range .Activities}}
            <li>
                {{if eq .Type "post"}}📝 Nouveau post : {{.Content}}
                {{else if eq .Type "comment"}}💬 Commentaire : {{.Content}} (sur le post : "{{.Target}}")
                {{else if eq .Type "like_post"}}👍 A liké un post : "{{.Target}}"
                {{else if eq .Type "dislike_post"}}👎 A disliké un post : "{{.Target}}"
                {{else if eq .Type "like_comment"}}👍 A liké un commentaire : "{{.Target}}"
                {{else if eq .Type "dislike_comment"}}👎 A disliké un commentaire : "{{.Target}}"
                {{end}}<br>
                <small>{{.CreatedAt.Format "02/01/2006 15:04"}}</small>
            </li>
        {{end}}
        </ul>
    {{else}}
        <p>Ce profil est privé.</p>
    {{end}}

    
</body>
</html>

{{if .IsOwner}}
<script>
    
    document.getElementById("profile-form").addEventListener("submit", function(event) {
        event.preventDefault();
        
        let data = {
            username: document.getElementById("username").value.trim(),
            email: document.getElementById("email").value.trim(),
            old_password: document.getElementById("old-password").value,
            new_password: document.getElementById("new-password").value,
            is_public: document.getElementById("is-public").checked 
        };

        const currentUsername = document.getElementById("display-username").innerText;
        fetch("/user/profile/" + currentUsername, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(response => response.text().then(text => ({ status: response.status, body: text })))
        .then(res => {
            if (res.status === 200) {
                document.getElementById("success-message").style.display = "block";
                document.getElementById("error-message").style.display = "none";

                // Mettre à jour l'affichage du username et email
                document.getElementById("display-username").innerText = data.username;
                document.getElementById("display-email").innerText = data.email;

                // Réinitialiser les champs de mot de passe
                document.getElementById("old-password").value = "";
                document.getElementById("new-password").value = "";

                // Masquer le message de succès après 3 secondes
                setTimeout(() => {
                    document.getElementById("success-message").style.display = "none";
                }, 3000);
            } else {
                document.getElementById("error-message").innerText = "❌ " + res.body;
                document.getElementById("error-message").style.display = "block";
            }
        })
        .catch(error => {
            console.error("Erreur :", error);
            document.getElementById("error-message").innerText = "❌ Une erreur est survenue.";
            document.getElementById("error-message").style.display = "block";
        });
    });


    // Ouverture de la modale du casier
    document.getElementById("openWarnBtn").addEventListener("click", function () {
        document.getElementById("warnModal").style.display = "block";
    });

    // Fermeture de la modale (déjà appelée dans ton HTML via `onclick`)
    function closeWarnModal() {
        document.getElementById("warnModal").style.display = "none";
    }

           
</script>
{{end}}