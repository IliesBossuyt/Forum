<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil</title>
</head>
<body>
    <h2>Mon Profil</h2>
    <p><strong>Nom d'utilisateur :</strong> <span id="display-username">{{.Username}}</span></p>
    <p><strong>Email :</strong> <span id="display-email">{{.Email}}</span></p>
    <p><strong>Rôle :</strong> {{.Role}}</p>

    <h3>Modifier mon profil</h3>
    <form id="profile-form">
        <label>Nom d'utilisateur :</label>
        <input type="text" id="username" value="{{.Username}}" required><br>

        <label>Email :</label>
        <input type="email" id="email" value="{{.Email}}" required><br>

        <label>Ancien mot de passe :</label>
        <input type="password" id="old-password"><br>

        <label>Nouveau mot de passe :</label>
        <input type="password" id="new-password"><br>

        <button type="submit">Enregistrer</button>
    </form>

    <p id="success-message" style="color:green; display:none;">Mise à jour réussie !</p>
    <p id="error-message" style="color:red; display:none;"></p>

    <a href="/auth/logout">Se déconnecter</a>

    <script>
 document.getElementById("profile-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            let data = {
                username: document.getElementById("username").value.trim(),
                email: document.getElementById("email").value.trim(),
                old_password: document.getElementById("old-password").value,
                new_password: document.getElementById("new-password").value
            };

            fetch("/auth/profile", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(response => response.text().then(text => ({ status: response.status, body: text })))
            .then(res => {
                if (res.status === 200) {
                    document.getElementById("success-message").style.display = "block";
                    document.getElementById("error-message").style.display = "none";

                    // Mettre à jour l'affichage du username et email
                    document.getElementById("display-username").innerText = data.username;
                    document.getElementById("display-email").innerText = data.email;

                    // Réinitialiser les champs de mot de passe
                    document.getElementById("old-password").value = "";
                    document.getElementById("new-password").value = "";

                    // Masquer le message de succès après 3 secondes
                    setTimeout(() => {
                        document.getElementById("success-message").style.display = "none";
                    }, 3000);
                } else {
                    document.getElementById("error-message").innerText = "❌ " + res.body;
                    document.getElementById("error-message").style.display = "block";
                }
            })
            .catch(error => {
                console.error("Erreur :", error);
                document.getElementById("error-message").innerText = "❌ Une erreur est survenue.";
                document.getElementById("error-message").style.display = "block";
            });
        });
    </script>
</body>
</html>
