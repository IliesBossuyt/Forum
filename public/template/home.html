<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/home.css">
    <title>Forum</title>
</head>
<body>
    <h2>Bienvenue sur le Forum</h2>

    <form action="/user/create-post" method="POST" enctype="multipart/form-data">
        <textarea name="content" placeholder="Écrivez votre message..."></textarea><br>
        <input type="file" name="image" accept=".jpg, .jpeg, .png, .gif"><br>
        <button type="submit">Publier</button>
    </form>

    <h3>Publications récentes</h3>
    {{range .Posts}}
        <div id="post-{{.ID}}" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px;">
            <p><strong>Posté par :</strong> {{.Username}}</p>
            <p id="content-{{.ID}}">{{.Content}}</p>
            {{if .Image}}
                <img src="/entry/image/{{.ID}}" alt="Image postée" width="200" style="cursor: pointer;" onclick="openModal('/entry/image/{{.ID}}')">
            {{end}}
            
            <!-- Affichage des likes et dislikes-->
            <p>👍 <span id="likes-{{.ID}}">{{.Likes}}</span> | 👎 <span id="dislikes-{{.ID}}">{{.Dislikes}}</span></p>
            <button onclick="likePost('{{.ID}}', 1)">👍 Like</button>
            <button onclick="likePost('{{.ID}}', -1)">👎 Dislike</button>
            <button onclick="reportPost('{{.ID}}')">🚩 Signaler</button>

            <!-- Bouton Modifier : Seulement visible pour le créateur du post -->
            {{if eq .UserID $.UserID}}
                <button onclick="editPost('{{.ID}}')">✏ Modifier</button>
            {{end}}

            <!-- Bouton Supprimer : Visible pour le créateur du post et les admins -->
            {{if or (eq .UserID $.UserID) (eq $.Role "admin")}}
                <button onclick="openDeleteForm('{{.ID}}')">🗑 Supprimer</button>
            {{end}}


            <!-- Bouton Afficher/Masquer les commentaires -->
            <button onclick="toggleComments('{{.ID}}')">💬 Commentaires</button>

            <!-- Zone de commentaires -->
            <div id="comments-{{.ID}}" style="display:none; margin-top: 10px; padding-left: 15px;">
                {{ $post := . }}
                {{if .Comments}}
                    {{range .Comments}}
                        <div id="comment-{{.ID}}" style="border: 1px dashed #ccc; margin-bottom: 8px; padding: 5px;">
                            <p><strong>{{.Username}}</strong> : {{.Content}}</p>
                            <small style="color: #aaa;">Posté le {{.CreatedAt}}</small><br>                            
                            <p>
                                👍 <span id="comment-like-{{.ID}}">{{.Likes}}</span>
                                | 👎 <span id="comment-dislike-{{.ID}}">{{.Dislikes}}</span>
                            </p>
                            <button onclick="likeComment('{{.ID}}', 1)">👍 Like</button>
                            <button onclick="likeComment('{{.ID}}', -1)">👎 Dislike</button>
                            <button onclick="reportComment('{{.ID}}')">🚩 Signaler</button>

                            {{if eq .UserID $.UserID}}
                                <button onclick="editComment('{{.ID}}', '{{.Content}}')">✏ Modifier</button>
                            {{end}}
                            
                            {{if or (eq .UserID $.UserID) (eq $.Role "admin") (eq $.Role "moderator")}}
                                <button onclick="deleteComment('{{.ID}}')">🗑 Supprimer</button>
                            {{end}}                                            
                        </div>
                    {{end}}
                {{end}}
                

                <!-- Formulaire d'ajout de commentaire -->
                <textarea id="comment-content-{{.ID}}" placeholder="Ajouter un commentaire..." rows="2" style="width: 100%;"></textarea>
                <button onclick="submitComment('{{.ID}}')">Publier le commentaire</button>
            </div>
        </div>
    {{end}}


    <!-- Fenêtre modale pour afficher les images en grand -->
    <div id="imageModal" onclick="closeModal()">
        <span class="close">&times;</span>
        <img id="modalContent">
    </div>

    <!-- Formulaire de modification de post (caché par défaut) -->
    <div id="edit-form" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc;">
        <h3>Modifier le post</h3>
        <textarea id="edit-content" rows="3" style="width:100%;"></textarea>
        <input type="hidden" id="edit-post-id">
        <br>
        <label for="edit-image">Changer l'image :</label>
        <input type="file" id="edit-image" accept=".jpg, .jpeg, .png, .gif">
        <br>
        <label><input type="checkbox" id="delete-image"> Supprimer l'image</label>
        <br>
        <button onclick="submitEdit()">Enregistrer</button>
        <button onclick="closeEditForm()">Annuler</button>
    </div>

    <!-- Fenêtre modale pour confirmer la suppression (style similaire à la modale d'édition) -->
    <div id="delete-form" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc;">
        <h3>Confirmer la suppression</h3>
        <p>Voulez-vous vraiment supprimer ce post ? Cette action est irréversible.</p>
        <input type="hidden" id="delete-post-id">
        <br>
        <button onclick="confirmDelete()">🗑 Supprimer</button>
        <button onclick="closeDeleteForm()">Annuler</button>
    </div>

    <!-- Fenêtre modale pour confirmer la suppression d’un commentaire -->
    <div id="delete-comment-form" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc;">
        <h3>Confirmer la suppression</h3>
        <p>Voulez-vous vraiment supprimer ce commentaire ? Cette action est irréversible.</p>
        <input type="hidden" id="delete-comment-id">
        <br>
        <button onclick="confirmDeleteComment()">🗑 Supprimer</button>
        <button onclick="closeDeleteCommentForm()">Annuler</button>
    </div>

    <!-- Fenêtre modale pour modifier un commentaire -->
    <div id="edit-comment-form" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc;">
        <h3>Modifier le commentaire</h3>
        <textarea id="edit-comment-content" rows="3" style="width:100%;"></textarea>
        <input type="hidden" id="edit-comment-id">
        <br>
        <button onclick="submitEditComment()">Enregistrer</button>
        <button onclick="closeEditCommentForm()">Annuler</button>
    </div>


    
</body>
</html>


<script>
function likePost(postID, value) {
    fetch('/user/like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: parseInt(postID, 10), value: value })
    })
    .then(response => response.json()) // Récupérer la réponse JSON
    .then(data => {
        if (data.success) {
            // Mettre à jour les valeurs sans recharger la page
            document.getElementById(`likes-${postID}`).innerText = data.likes;
            document.getElementById(`dislikes-${postID}`).innerText = data.dislikes;
        } else {
            alert("Erreur : " + data.message);
        }
    })
    .catch(error => console.error("Erreur lors du like/dislike :", error));
}

// Ouvre la fenêtre de confirmation de suppression
function openDeleteForm(postID) {
    document.getElementById("delete-post-id").value = postID;
    let modal = document.getElementById("delete-form");
    modal.style.display = "block";
}

// Ferme la fenêtre modale de suppression   
function closeDeleteForm() {
    let modal = document.getElementById("delete-form");
    modal.style.display = "none";
}

// Confirme la suppression du post
function confirmDelete() {
    let postID = document.getElementById("delete-post-id").value;
    deletePost(postID);
    closeDeleteForm();
}

// Supprime le post
function deletePost(postID) {
    console.log("Suppression demandée pour le post ID :", postID);

    fetch('/user/delete-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: postID })
    })
    .then(response => response.json())
    .then(data => {
        console.log("Réponse JSON du serveur :", data);

        if (data.success) {
            console.log("Suppression réussie, tentative de suppression du post du DOM.");
            
            let postElement = document.getElementById(`post-${postID}`);
            console.log("🔍 Élément HTML trouvé ?", postElement !== null);

            if (postElement) {
                postElement.remove();
                console.log("🗑 Post supprimé du DOM.");
            } else {
                console.warn("Impossible de supprimer, élément introuvable dans le DOM !");
            }
        } else {
            console.error("Erreur reçue du serveur :", data.message);
            alert("Erreur : " + (data.message || "Réponse inattendue"));
        }
    })
    .catch(error => {
        console.error("Erreur JS :", error);
        alert("Une erreur est survenue lors de la suppression.");
    });
}








function editPost(postID) {
    let currentContent = document.getElementById(`content-${postID}`).innerText;
    document.getElementById("edit-content").value = currentContent;
    document.getElementById("edit-post-id").value = postID;

    // Décocher la case "Supprimer l'image" à chaque ouverture
    document.getElementById("delete-image").checked = false;

    document.getElementById("edit-form").style.display = "block";
}


function closeEditForm() {
    document.getElementById("edit-form").style.display = "none";
}

function submitEdit() {
    let postID = document.getElementById("edit-post-id").value;
    let newContent = document.getElementById("edit-content").value;
    let deleteImage = document.getElementById("delete-image").checked;
    let formData = new FormData();
    formData.append("post_id", postID);
    formData.append("content", newContent);
    formData.append("delete_image", deleteImage);

    let fileInput = document.getElementById("edit-image");
    if (fileInput.files.length > 0) {
        formData.append("image", fileInput.files[0]);
    }

    fetch('/user/edit-post', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mise à jour du texte du post
            document.getElementById(`content-${postID}`).innerText = newContent;

            // Récupération de l'élément image
            let imgElement = document.querySelector(`img[src^="/entry/image/${postID}"]`);

            if (data.imageUpdated) {
            if (!imgElement) {
                // Si l'image n'existe pas encore, on la crée
                imgElement = document.createElement("img");
                imgElement.style.cursor = "pointer";
                imgElement.width = 200;
                imgElement.alt = "Image postée";
                imgElement.onclick = function() { openModal(`/entry/image/${postID}`); };

                let postDiv = document.getElementById(`content-${postID}`).parentNode;
                
                // Insérer l'image juste après le paragraphe du contenu
                let contentElement = document.getElementById(`content-${postID}`);
                postDiv.insertBefore(imgElement, contentElement.nextSibling);
            }

            // Met à jour l'image avec un timestamp unique
            imgElement.src = `/entry/image/${postID}?t=${new Date().getTime()}`;
            imgElement.style.display = "block";
            } 
            if (data.imageDeleted) {
            let imgElement = document.querySelector(`img[src^="/entry/image/${postID}"]`);

            if (imgElement) {
                imgElement.remove(); // Supprime l'image du DOM
            }

            // Vérifie s'il y a le texte "image postée" et le supprime
            let textPlaceholder = document.querySelector(`#content-${postID} + p`);
            if (textPlaceholder && textPlaceholder.innerText.includes("image postée")) {
                textPlaceholder.remove();
            }
        }


            closeEditForm();
        } else {
            alert("Erreur : " + data.message);
        }
    })
    .catch(error => console.error("Erreur lors de la modification :", error));
}




function openModal(imageSrc) {
    let modal = document.getElementById("imageModal");
    let modalImg = document.getElementById("modalContent");

    modalImg.src = imageSrc;
    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.opacity = "1";
        modalImg.style.transform = "scale(1)";
    }, 10);
}

function closeModal() {
    let modal = document.getElementById("imageModal");
    let modalImg = document.getElementById("modalContent");

    modal.style.opacity = "0";
    modalImg.style.transform = "scale(0.5)";
    setTimeout(() => {
        modal.style.display = "none";
    }, 300);
}

function reportPost(postID) {
    const reason = prompt("Pourquoi signalez-vous ce post ? (optionnel)");
    if (reason === null) return;

    const payload = {
        post_id: Number(postID.toString().trim()),
        reason: reason.trim()
    };

    console.log("🔍 ReportPost → typeof postID:", typeof postID, "val:", postID);


    fetch("/user/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Le post a été signalé.");
        } else {
            alert("Une erreur est survenue.");
        }
    })
    .catch(() => alert("Erreur réseau."));
}



function toggleComments(postID) {
    const section = document.getElementById("comments-" + postID);
    if (section.style.display === "none") {
        section.style.display = "block";
    } else {
        section.style.display = "none";
    }
}

function submitComment(postID) {
    const textarea = document.getElementById("comment-content-" + postID);
    const content = textarea.value.trim();
    if (!content) {
        alert("Veuillez écrire un commentaire.");
        return;
    }

    fetch("/user/comment", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            post_id: Number(postID),
            content: content
        })
    })
    .then(res => res.json())
    .then(data => {
    if (data.success && data.comment) {
        const commentSection = document.getElementById("comments-" + postID);
        const textarea = document.getElementById("comment-content-" + postID);

        const div = document.createElement("div");
        div.id = `comment-${data.comment.id}`;
        div.style.border = "1px dashed #ccc";
        div.style.marginBottom = "8px";
        div.style.padding = "5px";

        div.innerHTML = `
        <p><strong>${data.comment.username}</strong> : ${data.comment.content}</p>
        <small style="color: #aaa;">Posté le ${data.comment.createdAt}</small><br>
        <p>
            👍 <span id="comment-like-${data.comment.id}">0</span>
            | 👎 <span id="comment-dislike-${data.comment.id}">0</span>
        </p>
        <button onclick="likeComment('${data.comment.id}', 1)">👍 Like</button>
        <button onclick="likeComment('${data.comment.id}', -1)">👎 Dislike</button>
        <button onclick="reportComment('${data.comment.id}')">🚩 Signaler</button>
        ${data.comment.canEdit ? `<button onclick="editComment('${data.comment.id}', '${data.comment.content.replace(/'/g, "\\'")}')">✏ Modifier</button>` : ""}
        ${data.comment.canDelete ? `<button onclick="deleteComment('${data.comment.id}')">🗑 Supprimer</button>` : ""}
    `;

        commentSection.insertBefore(div, textarea);
        textarea.value = "";
    } else {
        alert("Erreur : " + (data.message || "Ajout impossible"));
    }
})
    .catch(() => {
        alert("Erreur réseau ou serveur");
    });
}



function likeComment(commentID, value) {
    fetch("/user/like-comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            comment_id: parseInt(commentID, 10), 
            value: value
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("comment-like-" + commentID).innerText = data.likes;
            document.getElementById("comment-dislike-" + commentID).innerText = data.dislikes;
        } else {
            alert("Erreur lors du like/dislike du commentaire.");
        }
    })
    .catch(() => alert("Erreur réseau"));
}



function deleteComment(commentID) {
    document.getElementById("delete-comment-id").value = commentID;
    document.getElementById("delete-comment-form").style.display = "block";
}

function closeDeleteCommentForm() {
    document.getElementById("delete-comment-form").style.display = "none";
}

function confirmDeleteComment() {
    const commentID = document.getElementById("delete-comment-id").value;

    fetch("/user/delete-comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comment_id: parseInt(commentID, 10) })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const div = document.getElementById("comment-" + commentID);
            if (div) div.remove();
        } else {
            alert("Erreur lors de la suppression du commentaire.");
        }
    })
    .catch(() => alert("Erreur réseau"))
    .finally(() => {
        closeDeleteCommentForm();
    });
}




function editComment(commentID, content) {
    document.getElementById("edit-comment-id").value = commentID;
    document.getElementById("edit-comment-content").value = content;
    document.getElementById("edit-comment-form").style.display = "block";
}

function closeEditCommentForm() {
    document.getElementById("edit-comment-form").style.display = "none";
}

function submitEditComment() {
    const commentID = document.getElementById("edit-comment-id").value;
    const newContent = document.getElementById("edit-comment-content").value.trim();

    if (!newContent) {
        alert("Le contenu ne peut pas être vide.");
        return;
    }

    fetch("/user/edit-comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comment_id: parseInt(commentID), content: newContent })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const commentDiv = document.querySelector(`#comment-${commentID} p strong`).nextSibling;
            if (commentDiv) commentDiv.nodeValue = " : " + newContent;
            closeEditCommentForm();
        } else {
            alert("Erreur : " + data.message);
        }
    })
    .catch(() => alert("Erreur réseau"));
}



function reportComment(commentID) {
    const reason = prompt("Pourquoi signalez-vous ce commentaire ? (optionnel)");
    if (reason === null) return;

    const payload = {
        comment_id: parseInt(commentID),
        reason: reason.trim()
    };

    fetch("/user/report-comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Le commentaire a été signalé.");
        } else {
            alert("Erreur : " + data.message);
        }
    })
    .catch(() => alert("Erreur réseau"));
}

</script>
